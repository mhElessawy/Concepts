@model Concept.Models.StoreReturnHeader

@{
    ViewData["Title"] = "Edit Store Return";
    var details = ViewBag.Details as List<Concept.Models.StoreReturnDetails>;
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>Edit Store Return</h2>
        </div>
        <div class="col-md-6 text-end">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <form id="returnForm" asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" id="detailsJson" name="detailsJson" />

        <div class="card mb-3">
            <div class="card-header">
                <h5>Return Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Return Code</label>
                        <input asp-for="ReturnCode" class="form-control" readonly />
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label">Return Type <span class="text-danger">*</span></label>
                        <select asp-for="ReturnType" class="form-select" id="returnType" required>
                            <option value="">-- Select Return Type --</option>
                            <option value="1">Warehouse to Warehouse</option>
                            <option value="2">Warehouse to Department</option>
                            <option value="3">Department to Warehouse</option>
                            <option value="4">Department to Department</option>
                        </select>
                        <span asp-validation-for="ReturnType" class="text-danger"></span>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label">Return Date <span class="text-danger">*</span></label>
                        <input asp-for="ReturnDate" type="date" class="form-control" required />
                        <span asp-validation-for="ReturnDate" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Return Time <span class="text-danger">*</span></label>
                        <input asp-for="ReturnTime" type="time" class="form-control" required />
                        <span asp-validation-for="ReturnTime" class="text-danger"></span>
                    </div>
                </div>

                <div class="row" id="fromSection">
                    <div class="col-md-6 mb-3" id="fromWarehouseDiv" style="display:none;">
                        <label class="form-label">From Warehouse <span class="text-danger">*</span></label>
                        <select asp-for="FromWarehouseId" class="form-select" asp-items="ViewBag.Warehouses">
                            <option value="">-- Select Warehouse --</option>
                        </select>
                        <span asp-validation-for="FromWarehouseId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3" id="fromDepartmentDiv" style="display:none;">
                        <label class="form-label">From Department <span class="text-danger">*</span></label>
                        <select asp-for="FromDepartmentId" class="form-select" asp-items="ViewBag.Departments">
                            <option value="">-- Select Department --</option>
                        </select>
                        <span asp-validation-for="FromDepartmentId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3" id="toWarehouseDiv" style="display:none;">
                        <label class="form-label">To Warehouse <span class="text-danger">*</span></label>
                        <select asp-for="ToWarehouseId" class="form-select" asp-items="ViewBag.Warehouses">
                            <option value="">-- Select Warehouse --</option>
                        </select>
                        <span asp-validation-for="ToWarehouseId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3" id="toDepartmentDiv" style="display:none;">
                        <label class="form-label">To Department <span class="text-danger">*</span></label>
                        <select asp-for="ToDepartmentId" class="form-select" asp-items="ViewBag.Departments">
                            <option value="">-- Select Department --</option>
                        </select>
                        <span asp-validation-for="ToDepartmentId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea asp-for="AdditionalNotes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Return Items</h5>
                <button type="button" class="btn btn-sm btn-success" onclick="addItemRow()">
                    <i class="bi bi-plus-circle"></i> Add Item
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" id="itemsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 10%;">Category</th>
                                <th style="width: 10%;">Sub Category</th>
                                <th style="width: 15%;">Item</th>
                                <th style="width: 7%;">Available Qty</th>
                                <th style="width: 8%;">Batch</th>
                                <th style="width: 7%;">Quantity</th>
                                <th style="width: 8%;">UOM</th>
                                <th style="width: 8%;">SubUOM</th>
                                <th style="width: 7%;">Pack Size</th>
                                <th style="width: 7%;">Value/Unit</th>
                                <th style="width: 7%;">Price</th>
                                <th style="width: 8%;">Expired</th>
                                <th style="width: 5%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Changes
                </button>
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let itemCounter = 0;
        let categories = [];
        let uoms = [];

        $(document).ready(function () {
            // Load data
            loadCategories();
            loadUOMs();

            // Set return type on load
            var returnType = parseInt($('#returnType').val());
            if (returnType) {
                updateReturnFields(returnType);
            }

            // Return type change handler
            $('#returnType').change(function () {
                var type = parseInt($(this).val());
                updateReturnFields(type);
            });

            // Load existing details
            @if (details != null && details.Any())
            {
                    <text>
                    setTimeout(function() {
                        @foreach (var item in details)
                        {
                                <text>
                                addExistingItem(@item.CategoryId, @item.SubCategoryId, @item.ItemId, @item.UOMId,
                                                '@item.BatchNo', @item.Quantity, @item.SubUOMId, @item.PackSize,
                                                @item.ValueOrUnit, @item.PriceType, '@item.ExpiredDate.ToString("yyyy-MM-dd")');
                                </text>
                        }
                    }, 1000);
                    </text>
            }
        });

        function updateReturnFields(type) {
            $('#fromWarehouseDiv, #fromDepartmentDiv, #toWarehouseDiv, #toDepartmentDiv').hide();
            $('#FromWarehouseId, #FromDepartmentId, #ToWarehouseId, #ToDepartmentId').prop('required', false);

            switch (type) {
                case 1:
                    $('#fromWarehouseDiv, #toWarehouseDiv').show();
                    $('#FromWarehouseId, #ToWarehouseId').prop('required', true);
                    break;
                case 2:
                    $('#fromWarehouseDiv, #toDepartmentDiv').show();
                    $('#FromWarehouseId, #ToDepartmentId').prop('required', true);
                    break;
                case 3:
                    $('#fromDepartmentDiv, #toWarehouseDiv').show();
                    $('#FromDepartmentId, #ToWarehouseId').prop('required', true);
                    break;
                case 4:
                    $('#fromDepartmentDiv, #toDepartmentDiv').show();
                    $('#FromDepartmentId, #ToDepartmentId').prop('required', true);
                    break;
            }
        }

        function loadCategories() {
            $.get('@Url.Action("GetCategories", "StoreReturn")', function (data) {
                categories = data;
            });
        }

        function loadUOMs() {
            $.get('@Url.Action("GetUOMs", "StoreReturn")', function (data) {
                uoms = data;
            });
        }

        function addItemRow() {
            itemCounter++;
            let row = `
                <tr id="row_${itemCounter}">
                    <td>
                        <select class="form-select form-select-sm categorySelect" data-row="${itemCounter}" required>
                            <option value="">Select</option>
                            ${categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm subCategorySelect" data-row="${itemCounter}" required>
                            <option value="">Select Category First</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm itemSelect" data-row="${itemCounter}" required>
                            <option value="">Select SubCategory First</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" step="0.01" class="form-control form-control-sm" id="availableQty_${itemCounter}" readonly style="background-color: #e9ecef;" />
                        <input type="hidden" id="availableQtyValue_${itemCounter}" value="0" />
                    </td>
                    <td>
                        <select class="form-select form-select-sm batchSelect" data-row="${itemCounter}" id="batch_${itemCounter}">
                            <option value="">Select Item First</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="quantity_${itemCounter}" onchange="validateQuantity(${itemCounter})" required /></td>
                    <td>
                        <select class="form-select form-select-sm uomSelect" data-row="${itemCounter}" required>
                            <option value="">Select</option>
                            ${uoms.map(u => `<option value="${u.id}">${u.uomName}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm subUomSelect" data-row="${itemCounter}" id="subUOM_${itemCounter}" required>
                            <option value="">Select UOM First</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control form-control-sm" id="packSize_${itemCounter}" readonly /></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="valueUnit_${itemCounter}" readonly /></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="price_${itemCounter}" required /></td>
                    <td><input type="date" class="form-control form-control-sm" id="expiredDate_${itemCounter}" /></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow(${itemCounter})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#itemsTableBody').append(row);
            attachEventHandlers(itemCounter);
        }

        function addExistingItem(catId, subCatId, itemId, uomId, batchNo, qty, subUomId, packSize, valueUnit, price, expDate) {
            itemCounter++;
            let row = `
                <tr id="row_${itemCounter}">
                    <td>
                        <select class="form-select form-select-sm categorySelect" data-row="${itemCounter}" required>
                            ${categories.map(c => `<option value="${c.id}" ${c.id == catId ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm subCategorySelect" data-row="${itemCounter}" required>
                            <option value="${subCatId}" selected>Loading...</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm itemSelect" data-row="${itemCounter}" required>
                            <option value="${itemId}" selected>Loading...</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" step="0.01" class="form-control form-control-sm" id="availableQty_${itemCounter}" readonly style="background-color: #e9ecef;" />
                        <input type="hidden" id="availableQtyValue_${itemCounter}" value="0" />
                    </td>
                    <td>
                        <select class="form-select form-select-sm batchSelect" data-row="${itemCounter}" id="batch_${itemCounter}">
                            <option value="${batchNo}" selected>${batchNo}</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="quantity_${itemCounter}" value="${qty}" onchange="validateQuantity(${itemCounter})" required /></td>
                    <td>
                        <select class="form-select form-select-sm uomSelect" data-row="${itemCounter}" required>
                            ${uoms.map(u => `<option value="${u.id}" ${u.id == uomId ? 'selected' : ''}>${u.uomName}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm subUomSelect" data-row="${itemCounter}" id="subUOM_${itemCounter}" required>
                            <option value="${subUomId}" selected>Loading...</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control form-control-sm" id="packSize_${itemCounter}" value="${packSize}" readonly /></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="valueUnit_${itemCounter}" value="${valueUnit}" readonly /></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm" id="price_${itemCounter}" value="${price}" required /></td>
                    <td><input type="date" class="form-control form-control-sm" id="expiredDate_${itemCounter}" value="${expDate}" /></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow(${itemCounter})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#itemsTableBody').append(row);

            // Load subcategories and subuoms
            loadSubCategories(catId, itemCounter);
            loadSubUOMs(uomId, itemCounter);

            attachEventHandlers(itemCounter);
        }

        function attachEventHandlers(rowId) {
            $(`.categorySelect[data-row="${rowId}"]`).change(function () {
                loadSubCategories($(this).val(), rowId);
            });

            $(`.subCategorySelect[data-row="${rowId}"]`).change(function () {
                loadItems($(this).val(), rowId);
            });

            $(`.itemSelect[data-row="${rowId}"]`).change(function () {
                loadItemDetails($(this).val(), rowId);
                loadBatches($(this).val(), rowId);
            });

            $(`.uomSelect[data-row="${rowId}"]`).change(function () {
                loadSubUOMs($(this).val(), rowId);
            });
        }

        function loadSubCategories(categoryId, rowId) {
            if (!categoryId) return;

            $.get(`@Url.Action("GetSubCategoriesByCategory", "StoreReturn")?categoryId=${categoryId}`, function (data) {
                let subCategorySelect = $(`.subCategorySelect[data-row="${rowId}"]`);
                let currentVal = subCategorySelect.val();
                subCategorySelect.empty();
                subCategorySelect.append('<option value="">Select SubCategory</option>');

                data.forEach(sc => {
                    subCategorySelect.append(`<option value="${sc.id}" ${sc.id == currentVal ? 'selected' : ''}>${sc.name}</option>`);
                });
            });
        }

        function loadItems(subCategoryId, rowId) {
            if (!subCategoryId) return;

            $.get(`@Url.Action("GetItemsBySubCategory", "StoreReturn")?subCategoryId=${subCategoryId}`, function (data) {
                let itemSelect = $(`.itemSelect[data-row="${rowId}"]`);
                itemSelect.empty();
                itemSelect.append('<option value="">Select Item</option>');

                data.forEach(item => {
                    itemSelect.append(`<option value="${item.id}">${item.itemName}</option>`);
                });
            });
        }

        function loadItemDetails(itemId, rowId) {
            if (!itemId) return;

            $.get(`@Url.Action("GetItemFullDetails", "StoreReturn")?itemId=${itemId}`, function (data) {
                if (data) {
                    $(`#packSize_${rowId}`).val(data.packSize || 0);
                    $(`#valueUnit_${rowId}`).val(data.purchaseValue || 0);
                    $(`#price_${rowId}`).val(data.purchaseValue || 0);

                    // عرض الكمية المتاحة في المخزن
                    $(`#availableQty_${rowId}`).val(data.quantityInStore || 0);
                    $(`#availableQtyValue_${rowId}`).val(data.quantityInStore || 0);

                    if (data.uomId) {
                        $(`.uomSelect[data-row="${rowId}"]`).val(data.uomId).trigger('change');
                    }
                }
            });
        }

        function loadBatches(itemId, rowId) {
            if (!itemId) return;

            $.get(`@Url.Action("GetBatchesByItem", "StoreReturn")?itemId=${itemId}`, function (data) {
                let batchSelect = $(`#batch_${rowId}`);
                batchSelect.empty();
                batchSelect.append('<option value="">Select Batch</option>');

                data.forEach(batch => {
                    batchSelect.append(`<option value="${batch.batchNo}" data-expired="${batch.expiredDate}">Batch ${batch.batchNo} - Qty: ${batch.availableQuantity}</option>`);
                });

                batchSelect.change(function () {
                    let expired = $(this).find(':selected').data('expired');
                    if (expired) {
                        $(`#expiredDate_${rowId}`).val(expired);
                    }
                });
            });
        }

        function loadSubUOMs(uomId, rowId) {
            if (!uomId) return;

            $.get(`@Url.Action("GetSubUOMsByUOM", "StoreReturn")?uomId=${uomId}`, function (data) {
                let subUomSelect = $(`#subUOM_${rowId}`);
                let currentVal = subUomSelect.val();
                subUomSelect.empty();
                subUomSelect.append('<option value="">Select SubUOM</option>');

                data.forEach(su => {
                    subUomSelect.append(`<option value="${su.id}" ${su.id == currentVal ? 'selected' : ''}>${su.subUOMName}</option>`);
                });
            });
        }

        function validateQuantity(rowId) {
            let enteredQty = parseFloat($(`#quantity_${rowId}`).val()) || 0;
            let availableQty = parseFloat($(`#availableQtyValue_${rowId}`).val()) || 0;

            if (enteredQty > availableQty) {
                alert(`الكمية المدخلة (${enteredQty}) أكبر من الكمية المتاحة (${availableQty})!\nالرجاء إدخال كمية أقل من أو تساوي الكمية المتاحة.`);
                $(`#quantity_${rowId}`).val('');
                $(`#quantity_${rowId}`).focus();
                return false;
            }

            return true;
        }

        function removeItemRow(rowId) {
            $(`#row_${rowId}`).remove();
        }

        $('#returnForm').submit(function (e) {
            e.preventDefault();

            let details = [];
            $('#itemsTableBody tr').each(function () {
                let rowId = $(this).attr('id').split('_')[1];
                let categoryId = $(this).find('.categorySelect').val();
                let subCategoryId = $(this).find('.subCategorySelect').val();
                let itemId = $(this).find('.itemSelect').val();

                if (categoryId && subCategoryId && itemId) {
                    details.push({
                        CategoryId: parseInt(categoryId),
                        SubCategoryId: parseInt(subCategoryId),
                        ItemId: parseInt(itemId),
                        UOMId: parseInt($(this).find('.uomSelect').val()) || 0,
                        BatchNo: $(`#batch_${rowId}`).val() || '',
                        Quantity: parseFloat($(`#quantity_${rowId}`).val()) || 0,
                        SubUOMId: parseInt($(`#subUOM_${rowId}`).val()) || 0,
                        PackSize: parseInt($(`#packSize_${rowId}`).val()) || 0,
                        ValueOrUnit: parseFloat($(`#valueUnit_${rowId}`).val()) || 0,
                        PriceType: parseFloat($(`#price_${rowId}`).val()) || 0,
                        TotalType: (parseFloat($(`#quantity_${rowId}`).val()) || 0) * (parseFloat($(`#price_${rowId}`).val()) || 0),
                        CostType: 0,
                        ExpiredDate: $(`#expiredDate_${rowId}`).val() || new Date().toISOString().split('T')[0],
                        Remark: ''
                    });
                }
            });

            if (details.length === 0) {
                alert('Please add at least one item');
                return false;
            }

            $('#detailsJson').val(JSON.stringify(details));
            this.submit();
        });
    </script>

    <style>
        .table-sm td, .table-sm th {
            padding: 0.25rem;
            vertical-align: middle;
        }

        .form-select-sm, .form-control-sm {
            font-size: 0.875rem;
        }

        .table-responsive {
            overflow-x: auto;
        }
    </style>
}