@model StoreItem

@{
    ViewData["Title"] = "Add New Item";
}

<div class="page-header">
    <h2><i class="bi bi-plus-circle"></i> Add New Item</h2>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-body p-4">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="row g-3">
                        <!-- Basic Information -->
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ItemCode" class="form-label">Item Code <span class="text-danger">*</span></label>
                            <input asp-for="ItemCode" class="form-control" placeholder="Enter item code" />
                            <span asp-validation-for="ItemCode" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="HRCode" class="form-label">Reference Code</label>
                            <input asp-for="HRCode" class="form-control" placeholder="Optional code" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ItemName" class="form-label">Item Name <span class="text-danger">*</span></label>
                            <input asp-for="ItemName" class="form-control" placeholder="Enter item name" />
                            <span asp-validation-for="ItemName" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ShortItemName" class="form-label">Short Name <span class="text-danger">*</span></label>
                            <input asp-for="ShortItemName" class="form-control" placeholder="Enter short name" />
                            <span asp-validation-for="ShortItemName" class="text-danger"></span>
                        </div>

                        <div class="col-md-12">
                            <label asp-for="Description" class="form-label">Description</label>
                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Detailed description"></textarea>
                        </div>

                        <!-- Category and Units -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-tags"></i> Category & Units
                            </h5>
                        </div>

                        <!-- Category Selection -->
                        <div class="col-md-6">
                            <label for="CategoryId" class="form-label">Category</label>
                            <select id="CategoryId" class="form-select">
                                <option value="">-- Select Category --</option>
                                @if (ViewBag.Categories != null)
                                {
                                    foreach (var cat in ViewBag.Categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Sub Category Selection -->
                        <div class="col-md-6">
                            <label asp-for="SubCategoryId" class="form-label">Sub Category</label>
                            <select asp-for="SubCategoryId" id="SubCategoryId" class="form-select">
                                <option value="">-- Select Category First --</option>
                            </select>
                        </div>

                        <!-- UOM Selection -->
                        <div class="col-md-6">
                            <label for="UOMId" class="form-label">Unit of Measure</label>
                            <select id="UOMId" class="form-select">
                                <option value="">-- Select UOM --</option>
                                @if (ViewBag.UOMs != null)
                                {
                                    foreach (var uom in ViewBag.UOMs)
                                    {
                                        <option value="@uom.Id">@uom.UOMName</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Sub UOM Selection -->
                        <div class="col-md-6">
                            <label asp-for="SubUOMId" class="form-label">Sub Unit</label>
                            <select asp-for="SubUOMId" id="SubUOMId" class="form-select">
                                <option value="">-- Select UOM First --</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PackSize" class="form-label">Pack Size</label>
                            <input asp-for="PackSize" type="number" id="PackSize" class="form-control" placeholder="e.g., 12" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="CountryId" class="form-label">Country</label>
                            <select asp-for="CountryId" class="form-select">
                                <option value="">-- Select Country --</option>
                                @if (ViewBag.Countries != null)
                                {
                                    foreach (var country in ViewBag.Countries)
                                    {
                                        <option value="@country.Id">@country.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="HSBarcode" class="form-label">Barcode</label>
                            <input asp-for="HSBarcode" class="form-control" placeholder="Barcode number" />
                        </div>

                        <!-- Inventory and Pricing -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-cash-stack"></i> Inventory & Pricing
                            </h5>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="QuantityInStore" class="form-label">Quantity in Store <span class="text-muted">(Read Only)</span></label>
                            <input asp-for="QuantityInStore" type="number" step="0.001" class="form-control" placeholder="0.000" value="0" readonly style="background-color: #f0f0f0; cursor: not-allowed;" />
                            <small class="text-muted">Can only be updated via Store Received</small>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="MinCity" class="form-label">Minimum Level</label>
                            <input asp-for="MinCity" type="number" class="form-control" placeholder="Minimum quantity" />
                        </div>

                        <div class="col-md-4">
                            <label asp-for="MaxCity" class="form-label">Maximum Level</label>
                            <input asp-for="MaxCity" type="number" class="form-control" placeholder="Maximum quantity" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PurchaseValue" class="form-label">Purchase Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="PurchaseValue" type="number" step="0.01" id="PurchaseValue" class="form-control" placeholder="0.00" value="0" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="SaleValue" class="form-label">Sale Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="SaleValue" type="number" step="0.01" id="SaleValue" class="form-control" placeholder="0.00" value="0" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PurchaseValueDefault" class="form-label">Default Purchase Price <span class="text-muted">(Auto Calculated)</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="PurchaseValueDefault" type="number" step="0.01" id="PurchaseValueDefault" class="form-control" placeholder="0.00" value="0" readonly style="background-color: #f0f0f0; cursor: not-allowed;" />
                            </div>
                            <small class="text-muted">= Purchase Price / Pack Size</small>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="SaleValueDefault" class="form-label">Default Sale Price <span class="text-muted">(Auto Calculated)</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="SaleValueDefault" type="number" step="0.01" id="SaleValueDefault" class="form-control" placeholder="0.00" value="0" readonly style="background-color: #f0f0f0; cursor: not-allowed;" />
                            </div>
                            <small class="text-muted">= Sale Price / Pack Size</small>
                        </div>

                        <!-- Additional Information -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Additional Information
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="OperationWeight" class="form-label">Weight</label>
                            <input asp-for="OperationWeight" class="form-control" placeholder="Item weight" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="UserId" class="form-label">Responsible User</label>
                            <select asp-for="UserId" class="form-select">
                                <option value="">-- Select User --</option>
                                @if (ViewBag.Users != null)
                                {
                                    foreach (var user in ViewBag.Users)
                                    {
                                        <option value="@user.Id">@user.FullName</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label asp-for="OperationsOrOperations" class="form-label">Operations</label>
                            <textarea asp-for="OperationsOrOperations" class="form-control" rows="2" placeholder="Operation details"></textarea>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input asp-for="Active" class="form-check-input" type="checkbox" checked />
                                <label asp-for="Active" class="form-check-label">Active</label>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Item
                            </button>
                            <a href="/Items" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            console.log('Page loaded - initializing dropdowns');

            // Function to calculate default values
            function calculateDefaultValues() {
                var purchaseValue = parseFloat($('#PurchaseValue').val()) || 0;
                var saleValue = parseFloat($('#SaleValue').val()) || 0;
                var packSize = parseInt($('#PackSize').val()) || 0;

                if (packSize > 0) {
                    var purchaseDefault = (purchaseValue / packSize).toFixed(2);
                    var saleDefault = (saleValue / packSize).toFixed(2);

                    $('#PurchaseValueDefault').val(purchaseDefault);
                    $('#SaleValueDefault').val(saleDefault);
                } else {
                    $('#PurchaseValueDefault').val('0.00');
                    $('#SaleValueDefault').val('0.00');
                }
            }

            // Attach change events to trigger calculation
            $('#PurchaseValue, #SaleValue, #PackSize').on('input change', function() {
                calculateDefaultValues();
            });

            // Category -> SubCategory
            $('#CategoryId').change(function() {
                var categoryId = $(this).val();
                var subCategoryDropdown = $('#SubCategoryId');

                console.log('Category changed:', categoryId);

                if (categoryId) {
                    subCategoryDropdown.prop('disabled', true)
                        .empty()
                        .append('<option value="">-- Loading... --</option>');

                    $.ajax({
                        url: '/Items/GetSubCategoriesByCategory',
                        type: 'GET',
                        data: { categoryId: categoryId },
                        success: function(data) {
                            console.log('SubCategories received:', data);
                            subCategoryDropdown.prop('disabled', false)
                                .empty()
                                .append('<option value="">-- Select Sub Category --</option>');

                            if (data && data.length > 0) {
                                $.each(data, function(i, item) {
                                    subCategoryDropdown.append(
                                        $('<option></option>')
                                            .val(item.id)
                                            .html(item.name)
                                    );
                                });
                            } else {
                                subCategoryDropdown.append('<option value="">-- No Sub Categories Found --</option>');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading subcategories:', error);
                            subCategoryDropdown.prop('disabled', false)
                                .empty()
                                .append('<option value="">-- Error Loading --</option>');
                            alert('Error loading sub categories. Please try again.');
                        }
                    });
                } else {
                    subCategoryDropdown.prop('disabled', false)
                        .empty()
                        .append('<option value="">-- Select Category First --</option>');
                }
            });

            // UOM -> SubUOM
            $('#UOMId').change(function() {
                var uomId = $(this).val();
                var subUOMDropdown = $('#SubUOMId');

                console.log('UOM changed:', uomId);

                if (uomId) {
                    subUOMDropdown.prop('disabled', true)
                        .empty()
                        .append('<option value="">-- Loading... --</option>');

                    $.ajax({
                        url: '/Items/GetSubUOMsByUOM',
                        type: 'GET',
                        data: { uomId: uomId },
                        success: function(data) {
                            console.log('SubUOMs received:', data);
                            subUOMDropdown.prop('disabled', false)
                                .empty()
                                .append('<option value="">-- Select Sub Unit --</option>');

                            if (data && data.length > 0) {
                                $.each(data, function(i, item) {
                                    subUOMDropdown.append(
                                        $('<option></option>')
                                            .val(item.id)
                                            .html(item.subUOMName)
                                    );
                                });
                            } else {
                                subUOMDropdown.append('<option value="">-- No Sub Units Found --</option>');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading sub UOMs:', error);
                            subUOMDropdown.prop('disabled', false)
                                .empty()
                                .append('<option value="">-- Error Loading --</option>');
                            alert('Error loading sub units. Please try again.');
                        }
                    });
                } else {
                    subUOMDropdown.prop('disabled', false)
                        .empty()
                        .append('<option value="">-- Select UOM First --</option>');
                }
            });

            // Test if jQuery is loaded
            console.log('jQuery version:', $.fn.jquery);
        });
    </script>
}
