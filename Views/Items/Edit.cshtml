@model StoreItem

@{
    ViewData["Title"] = "Edit Item";
}

<div class="page-header">
    <h2><i class="bi bi-pencil-square"></i> Edit Item: @Model.ItemName</h2>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-body p-4">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="CreatedDate" />

                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="row g-3">
                        <!-- Basic Information -->
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ItemCode" class="form-label">Item Code <span class="text-danger">*</span></label>
                            <input asp-for="ItemCode" class="form-control" />
                            <span asp-validation-for="ItemCode" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="HRCode" class="form-label">Reference Code</label>
                            <input asp-for="HRCode" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ItemName" class="form-label">Item Name <span class="text-danger">*</span></label>
                            <input asp-for="ItemName" class="form-control" />
                            <span asp-validation-for="ItemName" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ShortItemName" class="form-label">Short Name <span class="text-danger">*</span></label>
                            <input asp-for="ShortItemName" class="form-control" />
                            <span asp-validation-for="ShortItemName" class="text-danger"></span>
                        </div>

                        <div class="col-md-12">
                            <label asp-for="Description" class="form-label">Description</label>
                            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                        </div>

                        <!-- Category and Units -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-tags"></i> Category & Units
                            </h5>
                        </div>

                        <!-- Category Selection -->
                        <div class="col-md-6">
                            <label for="CategoryId" class="form-label">Category</label>
                            <select id="CategoryId" class="form-select">
                                <option value="">-- Select Category --</option>
                                @{
                                    var categories = (ViewBag.SubCategories as List<DeffSubCategory>)?
                                    .Select(sc => sc.Category)
                                    .DistinctBy(c => c.Id)
                                    .OrderBy(c => c.Name)
                                    .ToList();
                                    var selectedCategoryId = Model.SubCategory?.CategoryId;
                                }
                                @if (categories != null)
                                {
                                    foreach (var cat in categories)
                                    {
                                        <option value="@cat.Id" selected="@(cat.Id == selectedCategoryId)">@cat.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Sub Category Selection -->
                        <div class="col-md-6">
                            <label asp-for="SubCategoryId" class="form-label">Sub Category</label>
                            <select asp-for="SubCategoryId" id="SubCategoryId" class="form-select">
                                <option value="">-- Select Category First --</option>
                                @foreach (var subCat in ViewBag.SubCategories as List<DeffSubCategory>)
                                {
                                    if (subCat.CategoryId == selectedCategoryId)
                                    {
                                        <option value="@subCat.Id" selected="@(subCat.Id == Model.SubCategoryId)">@subCat.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- UOM Selection -->
                        <div class="col-md-6">
                            <label for="UOMId" class="form-label">Unit of Measure</label>
                            <select id="UOMId" class="form-select">
                                <option value="">-- Select UOM --</option>
                                @{
                                    var uoms = (ViewBag.SubUOMs as List<DefSubUOM>)?
                                    .Select(su => su.UOM)
                                    .DistinctBy(u => u.Id)
                                    .OrderBy(u => u.UOMName)
                                    .ToList();
                                    var selectedUOMId = Model.SubUOM?.UOMId;
                                }
                                @if (uoms != null)
                                {
                                    foreach (var uom in uoms)
                                    {
                                        <option value="@uom.Id" selected="@(uom.Id == selectedUOMId)">@uom.UOMName</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Sub UOM Selection -->
                        <div class="col-md-6">
                            <label asp-for="SubUOMId" class="form-label">Sub Unit</label>
                            <select asp-for="SubUOMId" id="SubUOMId" class="form-select">
                                <option value="">-- Select UOM First --</option>
                                @foreach (var subUOM in ViewBag.SubUOMs as List<DefSubUOM>)
                                {
                                    if (subUOM.UOMId == selectedUOMId)
                                    {
                                        <option value="@subUOM.Id" selected="@(subUOM.Id == Model.SubUOMId)">@subUOM.SubUOMName</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PackSize" class="form-label">Pack Size</label>
                            <input asp-for="PackSize" type="number" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="CountryId" class="form-label">Country</label>
                            <select asp-for="CountryId" class="form-select">
                                <option value="">-- Select Country --</option>
                                @foreach (var country in ViewBag.Countries as List<DeffCountry>)
                                {
                                    <option value="@country.Id">@country.Name</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="HSBarcode" class="form-label">Barcode</label>
                            <input asp-for="HSBarcode" class="form-control" />
                        </div>

                        <!-- Inventory and Pricing -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-cash-stack"></i> Inventory & Pricing
                            </h5>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="QuantityInStore" class="form-label">Quantity in Store</label>
                            <input asp-for="QuantityInStore" type="number" step="0.001" class="form-control" />
                        </div>

                        <div class="col-md-4">
                            <label asp-for="MinCity" class="form-label">Minimum Level</label>
                            <input asp-for="MinCity" type="number" class="form-control" />
                        </div>

                        <div class="col-md-4">
                            <label asp-for="MaxCity" class="form-label">Maximum Level</label>
                            <input asp-for="MaxCity" type="number" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PurchaseValue" class="form-label">Purchase Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="PurchaseValue" type="number" step="0.01" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="SaleValue" class="form-label">Sale Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="SaleValue" type="number" step="0.01" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PurchaseValueDefault" class="form-label">Default Purchase Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="PurchaseValueDefault" type="number" step="0.01" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="SaleValueDefault" class="form-label">Default Sale Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="SaleValueDefault" type="number" step="0.01" class="form-control" />
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="col-12 mt-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Additional Information
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="OperationWeight" class="form-label">Weight</label>
                            <input asp-for="OperationWeight" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input asp-for="Active" class="form-check-input" type="checkbox" />
                                <label asp-for="Active" class="form-check-label">Active</label>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <label asp-for="OperationsOrOperations" class="form-label">Operations</label>
                            <textarea asp-for="OperationsOrOperations" class="form-control" rows="2"></textarea>
                        </div>

                        <!-- Buttons -->
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                            <a href="/Items" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Category -> SubCategory
            $('#CategoryId').change(function() {
                var categoryId = $(this).val();
                var subCategoryDropdown = $('#SubCategoryId');

                subCategoryDropdown.empty().append('<option value="">-- Loading... --</option>');

                if (categoryId) {
                    $.ajax({
                        url: '/Items/GetSubCategoriesByCategory',
                        type: 'GET',
                        data: { categoryId: categoryId },
                        success: function(data) {
                            subCategoryDropdown.empty().append('<option value="">-- Select Sub Category --</option>');
                            $.each(data, function(i, item) {
                                subCategoryDropdown.append($('<option></option>').val(item.id).html(item.name));
                            });
                        }
                    });
                } else {
                    subCategoryDropdown.empty().append('<option value="">-- Select Category First --</option>');
                }
            });

            // UOM -> SubUOM
            $('#UOMId').change(function() {
                var uomId = $(this).val();
                var subUOMDropdown = $('#SubUOMId');

                subUOMDropdown.empty().append('<option value="">-- Loading... --</option>');

                if (uomId) {
                    $.ajax({
                        url: '/Items/GetSubUOMsByUOM',
                        type: 'GET',
                        data: { uomId: uomId },
                        success: function(data) {
                            subUOMDropdown.empty().append('<option value="">-- Select Sub Unit --</option>');
                            $.each(data, function(i, item) {
                                subUOMDropdown.append($('<option></option>').val(item.id).html(item.subUOMName));
                            });
                        }
                    });
                } else {
                    subUOMDropdown.empty().append('<option value="">-- Select UOM First --</option>');
                }
            });
        });
    </script>
}